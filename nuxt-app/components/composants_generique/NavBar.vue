<template>
    <div class="hidden md:flex top-0 bg-white shadow-md items-center justify-between px-8 py-02">
        <h1 class="w-3/12">
            <a href="">
                <svg width="305" height="40" viewBox="0 0 313 49" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M140.045 48V1.45454H171.409V9.56818H149.886V20.6591H169.795V28.7727H149.886V39.8864H171.5V48H140.045ZM189.006 48.6591C186.778 48.6591 184.794 48.2727 183.051 47.5C181.309 46.7121 179.93 45.553 178.915 44.0227C177.915 42.4773 177.415 40.553 177.415 38.25C177.415 36.3106 177.771 34.6818 178.483 33.3636C179.195 32.0455 180.165 30.9848 181.392 30.1818C182.619 29.3788 184.013 28.7727 185.574 28.3636C187.15 27.9545 188.801 27.6667 190.528 27.5C192.559 27.2879 194.195 27.0909 195.438 26.9091C196.68 26.7121 197.581 26.4242 198.142 26.0455C198.703 25.6667 198.983 25.1061 198.983 24.3636V24.2273C198.983 22.7879 198.528 21.6742 197.619 20.8864C196.725 20.0985 195.453 19.7045 193.801 19.7045C192.059 19.7045 190.672 20.0909 189.642 20.8636C188.612 21.6212 187.93 22.5758 187.597 23.7273L178.642 23C179.097 20.8788 179.991 19.0455 181.324 17.5C182.657 15.9394 184.377 14.7424 186.483 13.9091C188.604 13.0606 191.059 12.6364 193.847 12.6364C195.786 12.6364 197.642 12.8636 199.415 13.3182C201.203 13.7727 202.786 14.4773 204.165 15.4318C205.559 16.3864 206.657 17.6136 207.46 19.1136C208.263 20.5985 208.665 22.3788 208.665 24.4545V48H199.483V43.1591H199.21C198.65 44.25 197.9 45.2121 196.96 46.0455C196.021 46.8636 194.892 47.5076 193.574 47.9773C192.256 48.4318 190.733 48.6591 189.006 48.6591ZM191.778 41.9773C193.203 41.9773 194.46 41.697 195.551 41.1364C196.642 40.5606 197.498 39.7879 198.119 38.8182C198.741 37.8485 199.051 36.75 199.051 35.5227V31.8182C198.748 32.0152 198.331 32.197 197.801 32.3636C197.286 32.5152 196.703 32.6591 196.051 32.7955C195.4 32.9167 194.748 33.0303 194.097 33.1364C193.445 33.2273 192.854 33.3106 192.324 33.3864C191.188 33.553 190.195 33.8182 189.347 34.1818C188.498 34.5455 187.839 35.0379 187.369 35.6591C186.9 36.2652 186.665 37.0227 186.665 37.9318C186.665 39.25 187.142 40.2576 188.097 40.9545C189.066 41.6364 190.294 41.9773 191.778 41.9773ZM234.744 13.0909V20.3636H213.722V13.0909H234.744ZM218.494 4.72727H228.176V37.2727C228.176 38.1667 228.313 38.8636 228.585 39.3636C228.858 39.8485 229.237 40.1894 229.722 40.3864C230.222 40.5833 230.797 40.6818 231.449 40.6818C231.903 40.6818 232.358 40.6439 232.812 40.5682C233.267 40.4773 233.616 40.4091 233.858 40.3636L235.381 47.5682C234.896 47.7197 234.214 47.8939 233.335 48.0909C232.456 48.303 231.388 48.4318 230.131 48.4773C227.797 48.5682 225.752 48.2576 223.994 47.5455C222.252 46.8333 220.896 45.7273 219.926 44.2273C218.956 42.7273 218.479 40.8333 218.494 38.5455V4.72727ZM269.659 23.0455L260.795 23.5909C260.644 22.8333 260.318 22.1515 259.818 21.5455C259.318 20.9242 258.659 20.4318 257.841 20.0682C257.038 19.6894 256.076 19.5 254.955 19.5C253.455 19.5 252.189 19.8182 251.159 20.4545C250.129 21.0758 249.614 21.9091 249.614 22.9545C249.614 23.7879 249.947 24.4924 250.614 25.0682C251.28 25.6439 252.424 26.1061 254.045 26.4545L260.364 27.7273C263.758 28.4242 266.288 29.5455 267.955 31.0909C269.621 32.6364 270.455 34.6667 270.455 37.1818C270.455 39.4697 269.78 41.4773 268.432 43.2045C267.098 44.9318 265.265 46.2803 262.932 47.25C260.614 48.2045 257.939 48.6818 254.909 48.6818C250.288 48.6818 246.606 47.7197 243.864 45.7955C241.136 43.8561 239.538 41.2197 239.068 37.8864L248.591 37.3864C248.879 38.7955 249.576 39.8712 250.682 40.6136C251.788 41.3409 253.205 41.7045 254.932 41.7045C256.629 41.7045 257.992 41.3788 259.023 40.7273C260.068 40.0606 260.598 39.2045 260.614 38.1591C260.598 37.2803 260.227 36.5606 259.5 36C258.773 35.4242 257.652 34.9848 256.136 34.6818L250.091 33.4773C246.682 32.7955 244.144 31.6136 242.477 29.9318C240.826 28.25 240 26.1061 240 23.5C240 21.2576 240.606 19.3258 241.818 17.7045C243.045 16.0833 244.765 14.8333 246.977 13.9545C249.205 13.0758 251.811 12.6364 254.795 12.6364C259.205 12.6364 262.674 13.5682 265.205 15.4318C267.75 17.2955 269.235 19.8333 269.659 23.0455Z"
                        fill="#00E499" />
                    <path
                        d="M42.1136 17.75H32.1591C31.9773 16.4621 31.6061 15.3182 31.0455 14.3182C30.4849 13.303 29.7652 12.4394 28.8864 11.7273C28.0076 11.0151 26.9924 10.4697 25.8409 10.0909C24.7045 9.71212 23.4697 9.52273 22.1364 9.52273C19.7273 9.52273 17.6288 10.1212 15.8409 11.3182C14.053 12.5 12.6667 14.2273 11.6818 16.5C10.697 18.7576 10.2045 21.5 10.2045 24.7273C10.2045 28.0455 10.697 30.8333 11.6818 33.0909C12.6818 35.3485 14.0758 37.053 15.8636 38.2045C17.6515 39.3561 19.7197 39.9318 22.0682 39.9318C23.3864 39.9318 24.6061 39.7576 25.7273 39.4091C26.8636 39.0606 27.8712 38.553 28.75 37.8864C29.6288 37.2045 30.3561 36.3788 30.9318 35.4091C31.5227 34.4394 31.9318 33.3333 32.1591 32.0909L42.1136 32.1364C41.8561 34.2727 41.2121 36.3333 40.1818 38.3182C39.1667 40.2879 37.7955 42.053 36.0682 43.6136C34.3561 45.1591 32.3106 46.3864 29.9318 47.2955C27.5682 48.1894 24.8939 48.6364 21.9091 48.6364C17.7576 48.6364 14.0455 47.697 10.7727 45.8182C7.51515 43.9394 4.93939 41.2197 3.04545 37.6591C1.16667 34.0985 0.227273 29.7879 0.227273 24.7273C0.227273 19.6515 1.18182 15.3333 3.09091 11.7727C5 8.21212 7.59091 5.5 10.8636 3.63636C14.1364 1.75757 17.8182 0.81818 21.9091 0.81818C24.6061 0.81818 27.1061 1.19697 29.4091 1.95454C31.7273 2.71212 33.7803 3.81818 35.5682 5.27272C37.3561 6.71212 38.8106 8.47727 39.9318 10.5682C41.0682 12.6591 41.7955 15.053 42.1136 17.75ZM49.1705 48V1.45454H80.5341V9.56818H59.0114V20.6591H78.9205V28.7727H59.0114V39.8864H80.625V48H49.1705ZM113.608 14.8409C113.426 13.0076 112.646 11.5833 111.267 10.5682C109.888 9.55303 108.017 9.04545 105.653 9.04545C104.047 9.04545 102.691 9.27273 101.585 9.72727C100.479 10.1667 99.6307 10.7803 99.0398 11.5682C98.464 12.3561 98.1761 13.25 98.1761 14.25C98.1458 15.0833 98.3201 15.8106 98.6989 16.4318C99.0928 17.053 99.6307 17.5909 100.312 18.0455C100.994 18.4848 101.782 18.8712 102.676 19.2045C103.57 19.5227 104.525 19.7955 105.54 20.0227L109.722 21.0227C111.752 21.4773 113.616 22.0833 115.312 22.8409C117.009 23.5985 118.479 24.5303 119.722 25.6364C120.964 26.7424 121.926 28.0455 122.608 29.5455C123.305 31.0455 123.661 32.7652 123.676 34.7045C123.661 37.553 122.934 40.0227 121.494 42.1136C120.07 44.1894 118.009 45.803 115.312 46.9545C112.631 48.0909 109.396 48.6591 105.608 48.6591C101.85 48.6591 98.5777 48.0833 95.7898 46.9318C93.017 45.7803 90.8504 44.0758 89.2898 41.8182C87.7443 39.5455 86.9337 36.7348 86.858 33.3864H96.3807C96.4867 34.947 96.9337 36.25 97.7216 37.2955C98.5246 38.3258 99.5928 39.1061 100.926 39.6364C102.275 40.1515 103.797 40.4091 105.494 40.4091C107.161 40.4091 108.608 40.1667 109.835 39.6818C111.078 39.197 112.04 38.5227 112.722 37.6591C113.403 36.7955 113.744 35.803 113.744 34.6818C113.744 33.6364 113.434 32.7576 112.812 32.0455C112.206 31.3333 111.313 30.7273 110.131 30.2273C108.964 29.7273 107.532 29.2727 105.835 28.8636L100.767 27.5909C96.8428 26.6364 93.7443 25.1439 91.4716 23.1136C89.1989 21.0833 88.0701 18.3485 88.0852 14.9091C88.0701 12.0909 88.8201 9.62879 90.3352 7.52273C91.8655 5.41667 93.964 3.77273 96.6307 2.59091C99.2973 1.40909 102.328 0.81818 105.722 0.81818C109.176 0.81818 112.191 1.40909 114.767 2.59091C117.358 3.77273 119.373 5.41667 120.812 7.52273C122.252 9.62879 122.994 12.0682 123.04 14.8409H113.608ZM140.136 1.45454V48H130.295V1.45454H140.136Z"
                        fill="black" />
                    <rect x="275.5" y="39.5" width="37" height="8" fill="black" stroke="black" />
                </svg>
            </a>
        </h1>
        <div class="w-2/5 flex">
            <div class=" w-full relative hidden md:block">
                <div class="relative mr-3 md:mr-0 hidden md:block">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <input type="text" id="email-adress-icon"
                        class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-full bg-gray-50 focus:ring-emerald-400 focus:border-emerald-400"
                        placeholder="Search...">
                </div>
                <button data-collapse-toggle="mobile-menu-3" type="button"
                    class="md:hidden text-gray-400 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-emerald-400 rounded-lg inline-flex items-center justify-center"
                    aria-controls="mobile-menu-3" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <svg class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>


        <!-- navigation -->
        <nav class="nav font-semibold text-lg">
            <ul class="flex items-center">
                <li
                    class="p-4 border-b-2 border-emerald-400 border-opacity-0 hover:border-opacity-100 hover:text-emerald-400 duration-200 cursor-pointer active">
                    <NuxtLink to="../../pages_generique/settings">Mon compte</NuxtLink>
                </li>
                <li
                    class="p-4 border-b-2 border-emerald-400 border-opacity-0 hover:border-opacity-100 hover:text-emerald-400 duration-200 cursor-pointer active">
                    <NuxtLink to="../Suivi">Suivi</NuxtLink>
                </li>
            </ul>
        </nav>

        <div class="grid gap-6 md:grid-cols-3 xl:grid-cols-3 auto-rows-fr">
            <div class="bg-white-400 rounded p-0">
                <button @click="showNotifications = !showNotifications" :class="{
                    'text-red-500': hasUnreadNotifications || hasNewNotifications,
                    'text-black': !hasUnreadNotifications && !hasNewNotifications && notifications.length > 0,
                    'text-black': notifications.length === 0
                }">
                    <i class="fa fa-bell"></i>
                    <span v-if="hasNewNotifications" class="new-notification">Nouvelle(s)</span>
                </button>
                <div style="position: absolute; right: 30px" class="w-64">
                <div v-if="showNotifications" class="bg-emerald-400 rounded p-4 border-b border-emerald-400" v-for="notification in notifications"
                    :key="notification._id"
                    :class="['bg-emerald-400', 'rounded', 'p-4', { 'bg-white text-black': notification.read }]">
                    <h2 class="font-bold mb-2">{{ parseMessage(notification.message).Titre }}</h2>
                    <p>{{ parseMessage(notification.message).message }}</p>
                    <button @click="markNotificationAsRead(notification)" class="border-2 border-emerald-400 px-5 rounded">Vu</button>
                </div>
            </div>
            </div>
        </div>

        <!-- buttons --->
    <div class="flex justify-end">
        <a href="">
            <svg class="h-8 p-1 hover:text-emerald-400 duration-200 svg-inline--fa fa-shopping-cart fa-w-18 fa-7x"
                aria-hidden="true" focusable="false" data-prefix="far" data-icon="shopping-cart" role="img"
                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                <path fill="currentColor"
                    d="M551.991 64H144.28l-8.726-44.608C133.35 8.128 123.478 0 112 0H12C5.373 0 0 5.373 0 12v24c0 6.627 5.373 12 12 12h80.24l69.594 355.701C150.796 415.201 144 430.802 144 448c0 35.346 28.654 64 64 64s64-28.654 64-64a63.681 63.681 0 0 0-8.583-32h145.167a63.681 63.681 0 0 0-8.583 32c0 35.346 28.654 64 64 64 35.346 0 64-28.654 64-64 0-18.136-7.556-34.496-19.676-46.142l1.035-4.757c3.254-14.96-8.142-29.101-23.452-29.101H203.76l-9.39-48h312.405c11.29 0 21.054-7.869 23.452-18.902l45.216-208C578.695 78.139 567.299 64 551.991 64zM208 472c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm256 0c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm23.438-200H184.98l-31.31-160h368.548l-34.78 160z"
                    class=""></path>
            </svg>
        </a>
    </div>
</div>
</template>

<script lang="ts">
import { defineComponent, onMounted, ref, computed  } from 'vue'
import axios from 'axios'
import jwt_decode from "jwt-decode";
import '@fortawesome/fontawesome-free/css/fontawesome.css';
import '@fortawesome/fontawesome-free/css/solid.css';
import '@fortawesome/fontawesome-free/css/regular.css';
import '@fortawesome/fontawesome-free/css/brands.css';

export default {
    name: 'Notification',
  setup() {
    const notifications = ref([]);
    const showNotifications = ref(false);

    const parseMessage = (message) => {
      try {
        const parsedMessage = JSON.parse(message.replace(/'/g, '"'));
        return parsedMessage;
      } catch (error) {
        console.error(error);
        return {};
      }
    };

    const hasUnreadNotifications = computed(() => {
      return notifications.value.some(notification => !notification.read);
    });

    const hasNewNotifications = computed(() => {
      return notifications.value.some(notification => !notification.read);
    });

    const fetchData = async () => {
      try {
        const token = localStorage.getItem('authToken');
        const decoded_user_id = jwt_decode(token);
        console.log(decoded_user_id.id);

        const response = await axios.get(`http://localhost:3000/getAllNotificationByUserId/${decoded_user_id.id}`);
        const newNotifications = response.data.result.notifications;
        const hasNew = newNotifications.some(notification => !notification.read);

        // Mise à jour de la variable hasNewNotifications
        notifications.value = newNotifications;

        return newNotifications;
      } catch (error) {
        console.error(error);
        return [];
      }
    };

    const removeOrder = (notificationId) => {
      notifications.value = notifications.value.filter(notification => notification._id !== notificationId);
    };

    const markNotificationAsRead = async (notification) => {
      try {
        notification.read = true;
        // Faire une requête PUT vers l'API pour mettre à jour la notification
        await axios.put(`http://localhost:3000/updateNotification/${notification._id}`, { read: true });
      } catch (error) {
        console.error(error);
      }
    };

    onMounted(async () => {
      notifications.value = await fetchData();
      setInterval(async () => {
        notifications.value = await fetchData();
      }, 30000); // 30 secondes
    });

    return {
      notifications,
      markNotificationAsRead,
      removeOrder,
      parseMessage,
      showNotifications, // Ajout de la variable showNotifications à l'export
      hasUnreadNotifications,
      hasNewNotifications,
    };
  },
};

</script>


<style>
/* .bell-icon {
  color: red; */
/* Changer la couleur de l'icône en rouge */
/*}*/

.new-notification {
  background-color: red;
  color: white;
  padding: 2px 4px;
  border-radius : 15%;
  font-size: 12px;
  margin-left: 4px;
}

</style>